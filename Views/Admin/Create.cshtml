@model ITTicketSystem.Models.AdminCreateUserViewModel
@using ITTicketSystem.Models
@using Microsoft.AspNetCore.Mvc.Rendering
@using System

@{
    ViewData["Title"] = "Create User";

    // User departments dropdown source
    var userDepartments = ViewBag.UserDepartmentsSelectList as SelectList
                          ?? new SelectList(Enumerable.Empty<SelectListItem>());

    // Manager departments checklist source
    var allDepartments = ViewBag.AllDepartments as IEnumerable<Department>
                         ?? Enumerable.Empty<Department>();

    var roleUser = ((int)UserRole.User).ToString();
    var roleManager = ((int)UserRole.Manager).ToString();
    var roleAdmin = ((int)UserRole.Admin).ToString();
}

<h2 class="mb-3">Create User</h2>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <div>@err.ErrorMessage</div>
        }
    </div>
}

<form asp-action="Create" method="post" class="card shadow-sm">
    @Html.AntiForgeryToken()

    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Username</label>
                <input asp-for="UserName" class="form-control" autocomplete="off" />
                <span asp-validation-for="UserName" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">Password</label>
                <input asp-for="Password" type="password" class="form-control" />
                <span asp-validation-for="Password" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <label class="form-label">Role</label>

                <!-- ✅ خلي القيم أرقام enum -->
                <select asp-for="Role" class="form-select" id="roleSelect">
                    <option value="@roleUser">User</option>
                    <option value="@roleManager">Manager</option>
                    <option value="@roleAdmin">Admin</option>
                </select>

                <span asp-validation-for="Role" class="text-danger small"></span>
            </div>

            <div class="col-md-4">
                <div class="form-check mt-4">
                    <input asp-for="IsActive" class="form-check-input" />
                    <label class="form-check-label" asp-for="IsActive">Active</label>
                </div>
            </div>

            <!-- User Department (Dropdown) -->
            <div class="col-md-8" id="userDeptBlock">
                <label class="form-label">Department (User)</label>
                <select asp-for="DepartmentId" class="form-select" id="userDeptSelect"
                        asp-items="userDepartments">
                    <option value="">-- Select Department --</option>
                </select>
                <span asp-validation-for="DepartmentId" class="text-danger small"></span>

                <div class="form-check mt-2">
                    <input asp-for="CanManageDeptTickets" class="form-check-input" id="canManageChk" />
                    <label class="form-check-label" for="canManageChk">
                        Allow user to manage department tickets
                    </label>
                </div>
            </div>

            <!-- Manager Departments (Checklist) -->
            <div class="col-12" id="managerDeptBlock">
                <label class="form-label">Managed Departments (Manager)</label>

                <div class="border rounded p-3">
                    <div class="row g-2">
                        @foreach (var d in allDepartments)
                        {
                            var isChecked = Model.ManagedDepartmentIds != null && Model.ManagedDepartmentIds.Contains(d.Id);

                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           name="ManagedDepartmentIds"
                                           value="@d.Id"
                                           id="dep_@d.Id"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label" for="dep_@d.Id">@d.Name</label>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="small text-muted mt-2">
                        Select at least one department for a Manager.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="card-footer d-flex gap-2">
        <button type="submit" class="btn btn-primary">Create</button>
        <a asp-action="Index" class="btn btn-outline-secondary">Back</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const roleUser = "@roleUser";
            const roleManager = "@roleManager";
            const roleAdmin = "@roleAdmin";

            const roleSelect = document.getElementById("roleSelect");
            const userDeptBlock = document.getElementById("userDeptBlock");
            const managerDeptBlock = document.getElementById("managerDeptBlock");

            const userDeptSelect = document.getElementById("userDeptSelect");
            const canManageChk = document.getElementById("canManageChk");

            function updateRoleUI() {
                const role = roleSelect.value;

                if (role === roleUser) {
                    userDeptBlock.classList.remove("d-none");
                    managerDeptBlock.classList.add("d-none");

                    userDeptSelect.removeAttribute("disabled");
                    canManageChk.removeAttribute("disabled");
                }
                else if (role === roleManager) {
                    userDeptBlock.classList.add("d-none");
                    managerDeptBlock.classList.remove("d-none");

                    // ✅ disable حتى لا ينرسل DepartmentId
                    userDeptSelect.setAttribute("disabled", "disabled");
                    canManageChk.setAttribute("disabled", "disabled");
                }
                else { // Admin
                    userDeptBlock.classList.add("d-none");
                    managerDeptBlock.classList.add("d-none");

                    userDeptSelect.setAttribute("disabled", "disabled");
                    canManageChk.setAttribute("disabled", "disabled");
                }
            }

            roleSelect.addEventListener("change", updateRoleUI);
            updateRoleUI();
        })();
    </script>
}
