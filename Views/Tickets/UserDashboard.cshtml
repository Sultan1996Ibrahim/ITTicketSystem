@model ITTicketSystem.Models.UserDashboardViewModel
@using ITTicketSystem.Models

@{
    ViewData["Title"] = "Department Dashboard";

    bool canManage = ViewBag.CanManage == true;

    string PriorityBadgeClass(TicketPriority? priority) => priority switch
    {
        TicketPriority.Normal   => "badge bg-secondary",
        TicketPriority.High     => "badge bg-warning text-dark",
        TicketPriority.Critical => "badge bg-danger",
        null                    => "badge bg-light text-dark",
        _                       => "badge bg-light text-dark"
    };

    var sort = Context.Request.Query["sort"].ToString();
    var dir = Context.Request.Query["dir"].ToString();
}

<h2 class="mb-4">Department Tickets (View Only)</h2>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <a asp-action="UserDashboard" class="text-decoration-none text-dark">
            <div class="card text-bg-light border-light">
                <div class="card-body text-center">
                    <h6 class="card-title">Total</h6>
                    <h2>@Model.TotalTickets</h2>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a asp-action="UserDashboard" asp-route-filter="@TicketStatus.New" class="text-decoration-none text-dark">
            <div class="card text-bg-light border-light">
                <div class="card-body text-center">
                    <h6 class="card-title">New</h6>
                    <h2>@Model.NewCount</h2>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a asp-action="UserDashboard" asp-route-filter="@TicketStatus.InProgress" class="text-decoration-none text-dark">
            <div class="card text-bg-light border-light">
                <div class="card-body text-center">
                    <h6 class="card-title">In Progress</h6>
                    <h2>@Model.InProgressCount</h2>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-3">
        <a asp-action="UserDashboard" asp-route-filter="@TicketStatus.Closed" class="text-decoration-none text-dark">
            <div class="card text-bg-light border-light">
                <div class="card-body text-center">
                    <h6 class="card-title">Closed</h6>
                    <h2>@Model.ClosedCount</h2>
                </div>
            </div>
        </a>
    </div>
</div>

@if (Model.Tickets == null || !Model.Tickets.Any())
{
    <p>No tickets found.</p>
}
else
{
    <div class="grid-table-wrap">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-light grid-head">
                <tr>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Ticket Number", "ticketNumber", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Title", "title", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Department", "department", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("From Department", "fromDepartment", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeaderStatus", new GridHeaderStatusVM("Status", sort, dir))</th>
                    <th>Priority</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Created By", "createdBy", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Assigned To", "assignedTo", sort, dir))</th>
                    <th>@await Html.PartialAsync("_GridHeader", new GridHeaderVM("Created At", "createdAt", sort, dir))</th>

                    <th style="width:140px;">Quick View</th>

                    @if (canManage)
                    {
                        <th style="width:140px;">Manage</th>
                    }
                </tr>
            </thead>

            <tbody>
            @foreach (var t in Model.Tickets)
            {
                <tr>
                    <td>
                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@t.Id"
                           class="badge bg-light text-dark text-decoration-none">
                            @t.ReferenceNumber
                        </a>
                    </td>

                    <td>@t.Title</td>
                    <td>@t.Department?.Name</td>
                    <td>@(t.FromDepartment?.Name ?? "-")</td>

                    <td><partial name="~/Views/Shared/_TicketStatusBadge.cshtml" model="t.Status" /></td>

                    <td><span class="@PriorityBadgeClass(t.Priority)">@(t.Priority?.ToString() ?? "-")</span></td>

                    <td>@t.CreatedBy</td>
                    <td>@(t.AssignedUser?.UserName ?? "-")</td>
                    <td>@t.CreatedAt.ToLocalTime()</td>

                    <td>
                        <a asp-controller="Tickets"
                           asp-action="Details"
                           asp-route-id="@t.Id"
                           asp-route-from="dashboard"
                           class="btn btn-sm btn-outline-primary"
                           data-ticket-canvas="1">
                            Quick View
                        </a>
                    </td>

                    @if (canManage)
                    {
                        <td>
                            @if (t.Status == TicketStatus.New)
                            {
                                <form asp-controller="Tickets" asp-action="Manage" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-warning">
                                        Manage
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted small">-</span>
                            }
                        </td>
                    }
                </tr>
            }
            </tbody>
        </table>
    </div>
}
